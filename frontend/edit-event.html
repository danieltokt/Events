<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ - Event Management</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÖ</text></svg>">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1>Event Management</h1>
                <div class="header-actions">
                    <span class="user-greeting" id="userGreeting"></span>
                    <button class="btn btn-secondary btn-sm" onclick="logout()">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="form-container">
                <div class="form-header">
                    <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</h2>
                    <button class="btn btn-secondary" onclick="window.location.href='events.html'">
                        ‚Üê –ù–∞–∑–∞–¥
                    </button>
                </div>

                <div id="loadingState" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏—è...</div>

                <form id="editEventForm" class="event-form" style="display: none;">
                    <div class="form-group">
                        <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è *</label>
                        <input 
                            type="text" 
                            id="title" 
                            name="title" 
                            required 
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è"
                        >
                        <span class="error-message" id="titleError"></span>
                    </div>

                    <div class="form-group">
                        <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea 
                            id="description" 
                            name="description" 
                            rows="5"
                            placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–±—ã—Ç–∏–µ"
                        ></textarea>
                        <span class="error-message" id="descriptionError"></span>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                            <select id="category" name="category">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                <option value="conference">–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è</option>
                                <option value="workshop">–ü—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ</option>
                                <option value="meetup">–°–æ–±—Ä–∞–Ω–∏–µ</option>
                                <option value="webinar">–í–µ–±–∏–Ω–∞—Ä</option>
                                <option value="other">–î—Ä—É–≥–æ–µ</option>
                            </select>
                            <span class="error-message" id="categoryError"></span>
                        </div>

                        <div class="form-group">
                            <label for="location">–ú–µ—Å—Ç–æ</label>
                            <input 
                                type="text" 
                                id="location" 
                                name="location" 
                                placeholder="–ì–¥–µ –ø—Ä–æ–π–¥–µ—Ç —Å–æ–±—ã—Ç–∏–µ"
                            >
                            <span class="error-message" id="locationError"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ *</label>
                            <input 
                                type="datetime-local" 
                                id="startDate" 
                                name="startDate" 
                                required
                            >
                            <span class="error-message" id="startDateError"></span>
                        </div>

                        <div class="form-group">
                            <label for="endDate">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                            <input 
                                type="datetime-local" 
                                id="endDate" 
                                name="endDate"
                            >
                            <span class="error-message" id="endDateError"></span>
                        </div>
                    </div>

                    <div id="formError" class="error-message form-error"></div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="window.location.href='events.html'">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type="submit" class="btn btn-primary" id="updateBtn">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <div id="notification" class="notification"></div>

    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/events.js"></script>
    <script>
        // Check authentication
        checkAuth();
        
        // Load user info
        const user = getCurrentUser();
        if (user) {
            document.getElementById('userGreeting').textContent = `–ü—Ä–∏–≤–µ—Ç, ${user.username}!`;
        }
        
        // Get event ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');
        
        if (!eventId) {
            showNotification('ID —Å–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            setTimeout(() => window.location.href = 'events.html', 2000);
        } else {
            loadEventData();
        }
        
        async function loadEventData() {
            try {
                const event = await getEvent(eventId);
                
                // Populate form
                document.getElementById('title').value = event.title;
                document.getElementById('description').value = event.description || '';
                document.getElementById('category').value = event.category || '';
                document.getElementById('location').value = event.location || '';
                document.getElementById('startDate').value = formatDateTimeLocal(event.start_date);
                if (event.end_date) {
                    document.getElementById('endDate').value = formatDateTimeLocal(event.end_date);
                }
                
                // Show form
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('editEventForm').style.display = 'block';
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏—è', 'error');
                setTimeout(() => window.location.href = 'events.html', 2000);
            }
        }
        
        document.getElementById('editEventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const category = document.getElementById('category').value;
            const location = document.getElementById('location').value.trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // Client-side validation
            let hasError = false;
            
            if (!title) {
                document.getElementById('titleError').textContent = '–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ';
                hasError = true;
            }
            
            if (!startDate) {
                document.getElementById('startDateError').textContent = '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞';
                hasError = true;
            }
            
            if (endDate && startDate && new Date(endDate) < new Date(startDate)) {
                document.getElementById('endDateError').textContent = 
                    '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞';
                hasError = true;
            }
            
            if (hasError) return;
            
            const btn = document.getElementById('updateBtn');
            btn.disabled = true;
            btn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            
            try {
                const eventData = {
                    title,
                    description,
                    category,
                    location,
                    start_date: startDate,
                    end_date: endDate || null
                };
                
                await updateEvent(eventId, eventData);
                showNotification('–°–æ–±—ã—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                setTimeout(() => window.location.href = 'events.html', 1500);
            } catch (error) {
                btn.disabled = false;
                btn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
            }
        });
    </script>
</body>
</html>
